<div id="actionbar">
<span style="float: left;">
</span>
<span style="float: right;">
{% if mode == 'render' %}
{% if page.subtree.dirty() %}<a href="#" title="Draft" class="draft{% if version == None %} highlight{% endif %}"><i class="fas fa-drafting-compass"></i></a>{% endif %}
<a href="#" title="View source" class="raw"><i class="{% if mimetype == 'text/markdown' %}fab fa-markdown{% else %}fas fa-file-code{% endif %}"></i></a>
{% if g.user.is_admin %}
<a href="#" title="Edit" class="edit"><i class="fas fa-edit"></i></a>
{% endif %}
{% elif mode == 'raw' %}
{% if page.subtree.dirty() %}<a href="#" title="Draft" class="draft{% if version == None %} highlight{% endif %}"><i class="fas fa-drafting-compass"></i></a>{% endif %}
<a href="#" title="View source" class="raw highlight"><i class="{% if mimetype == 'text/markdown' %}fab fa-markdown{% else %}fas fa-file-code{% endif %}"></i></a>
{% if g.user.is_admin %}
<a href="#" title="Edit" class="edit"><i class="fas fa-edit"></i></a>
{% endif %}
{% elif  mode == 'edit' %}
<a href="#" title="Commit" class="commit hidden"><i class="fas fa-save"></i></a>
<a href="#" title="Revert" class="revert hidden"><i class="fas fa-history"></i></a>
<a href="#" title="View source" class="raw"><i class="{% if mimetype == 'text/markdown' %}fab fa-markdown{% else %}fas fa-file-code{% endif %}"></i></a>
<a href="#" title="Edit" class="edit highlight"><i class="fas fa-edit"></i></a>
{% endif %}
</span>
</div>

<script src="{{ url_for('static', filename='diff_match_patch.js') }}"></script>

<script>
$(() => {
    var url = new URL(window.location);
    url.search = '';

    var mode = '{{ mode }}';
    var dirty = {{ page.subtree.dirty(path) | lower }};
    var viewonly = {{ viewonly | lower }};
    var version = {{ version | tojson }};
    var source = $('#content > textarea.source');
    var source_last = source.val();
    var source_timeout = null;
    var dmp = new diff_match_patch();
    var commit_btn = $('#actionbar .commit');
    var revert_btn = $('#actionbar .revert');
    var draft_btn = $('#actionbar .draft');
    var raw_btn = $('#actionbar .raw');
    var edit_btn = $('#actionbar .edit');

    function source_save_patch(complete) {
        var source_text = source.val();
        var patch = dmp.patch_make(source_last, source_text);
        var patch_text = dmp.patch_toText(patch);
        $.post(url, {
            action: 'patch',
            patch: patch_text,
        }, (data) => {
            source_last = source_text;
            dirty = data.dirty;
            revert_btn.toggleClass('hidden', !dirty);
            commit_btn.toggleClass('hidden', !dirty);
            if (typeof complete == 'function') {
                complete();
            }
        });
    }

    function source_resize() {
        source.height('inherit');
        var height = parseInt(source.css('border-top-width'), 10)
                   - parseInt(source.css('padding-top'), 10)
                   + source.prop('scrollHeight')
                   - parseInt(source.css('padding-bottom'), 10)
                   + parseInt(source.css('border-bottom-width'), 10);
        source.height(height + 'px');
    }
    source_resize();

    source.on('input', (event) => {
        source_resize();
        if (source_timeout) {
            clearTimeout(source_timeout);
            source_timeout = null;
        }
        source_timeout = setTimeout(() => {
            source_save_patch();
            source_timeout = null;
        }, 1000);
    });
    
    commit_btn.on('click', () => {
        if (source_timeout) {
            clearTimeout(source_timeout);
            source_timeout = null;
        }
        source_save_patch(() => {
            $.post(url, {
                action: 'commit',
            }, (data) => {
                window.location = url;
            });
        });
        return false;
    });

    revert_btn.on('click', () => {
        if (source_timeout) {
            clearTimeout(source_timeout);
            source_timeout = null;
        }
        $.post(url, {
            action: 'revert',
        }, (data) => {
            location.reload();
        });
        return false;
    });

    raw_btn.on('click', () => {
        var search = new URLSearchParams();
        if (mode != 'raw' || mode == 'edit') {
            search.set('raw', '1');
        }
        url.search = search;
        window.location = url;
        return false;
    });

    edit_btn.on('click', () => {
        var search = new URLSearchParams();
        if (mode != 'edit' || mode == 'raw') {
            search.set('edit', '1');
        }
        url.search = search;
        window.location = url;
        return false;
    });


    draft_btn.on('click', () => {
        var parts = window.location.pathname.slice(1).split('/');        
        var page = parts.shift();
        var pathname;
        if (version == null) {
            pathname = '/' + page + '/_HEAD';
        } else {
            var _ = parts.shift();
            pathname = '/' + page
        }
        if (parts.length > 0 && parts[0] != '') {
            pathname += '/' + parts.join('/');
        }
        window.location.pathname = pathname;
        return false;
    });

    revert_btn.toggleClass('hidden', !dirty);
    commit_btn.toggleClass('hidden', !dirty);
    source.prop('readonly', mode != 'edit');
});
</script>