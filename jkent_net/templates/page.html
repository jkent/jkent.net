{% extends 'base.html' %}

{% block main %}

{% include 'actionbar.html' %}
<link rel="stylesheet" href="{{ url_for('static', filename='libs/mobile-drag-drop/release/default.css') }}">
<script src="{{ url_for('static', filename='libs/mobile-drag-drop/release/index.min.js') }}"></script>

<script>
MobileDragDrop.polyfill({
    iterationInterval: 100,
});

let treeview = new Treeview({
    draggable: true,
    droppable: true,
    root_folder: 'Root',
    file_drop: true,
});
$('#content').append(treeview.html);
treeview.select_handler = (selection) => {
    console.log('treeview', 'select', selection);
}
treeview.dblclick_handler = (path, shift) => {
    console.log('treeview', 'dblclick', path, shift);
};
treeview.drop_handler = (data) => {
    if (data.type == 'file') {
        let url = new URL(window.location);
        let search = new URLSearchParams();
        search.set('action', 'upload');
        url.search = search;
        let fd = new FormData();
        fd.append('dest', data.dest_node.path);
        $.each(data.source_files, (_, file) => fd.append('files', file));
        $.post({
            url: url,
            data: fd,
            processData: false,
            contentType: false,
            success: (json) => {
                $.each(json.paths, (_, path) =>
                    treeview.insert(data.dest_node.path + path));
            },
        });
    } else if (data.type == 'local') {
        let url = new URL(window.location);
        let search = new URLSearchParams();
        search.set('action', data.shift ? 'copy' : 'move');
        url.search = search;
        let fd = new FormData();
        fd.append('dest', data.dest_node.path);
        console.log(data.selected_parents);
        for (let node of data.selected_parents) {
            fd.append('paths', node.path);
        }
        $.post({
            url: url,
            data: fd,
            processData: false,
            contentType: false,
            success: (json) => {
                if (!data.shift) {
                    data.source_node.$li.trigger('dragend');
                    for (let node of data.selected_parents) {
                        data.source_tree.remove(node);
                    }
                }
                $.each(json.paths, (_, path) =>
                    treeview.insert(data.dest_node.path + path));
            }
        });
    }
};

let url = new URL(window.location);
let search = new URLSearchParams();
search.set('action', 'list');
url.search = search;
$.get(url, (data) => {
    $.each(data.paths, (_, path) => treeview.insert(path));
});

</script>
{% endblock %}