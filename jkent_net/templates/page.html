{% extends 'base.html' %}

{% block main %}

{% include 'actionbar.html' %}
<link rel="stylesheet" href="{{ url_for('static', filename='libs/mobile-drag-drop/release/default.css') }}">
<script src="{{ url_for('static', filename='libs/mobile-drag-drop/release/index.min.js') }}"></script>
<script src="{{ url_for('static', filename='libs/progressbar.js/dist/progressbar.min.js') }}"></script>

<script>
MobileDragDrop.polyfill({
    iterationInterval: 100,
});

let treeview = new Treeview({
    draggable: true,
    droppable: true,
    root_folder: 'Root',
    file_drop: true,
});
$('#content').append(treeview.html);
treeview.select_handler = (selection) => {
    console.log('treeview', 'select', selection);
}
treeview.dblclick_handler = (path, shift) => {
    console.log('treeview', 'dblclick', path, shift);
};
class Upload {
    constructor(treeview, parent, file) {
        if (Upload.active === undefined) {
            Upload.active = 0;
            Upload.queue = [];
        }

        this.treeview = treeview;
        this.file = file;
        this.parent = parent;
        this.node = treeview.insert(parent.path + file.name);

        if (this.node.$li.has('.progress').length) {
            return;
        };

        this.$progress = $('<span class="progress">');
        this.node.$li.find('>span').after(this.$progress);
        this.progressbar = new ProgressBar.Circle(this.$progress[0], {
            color: '#77f',
            strokeWidth: 16,
            trailWidth: 16,
        });
        this.$progress.addClass('rotating');
        this.progressbar.set(0.25);

        if (Upload.active < 2) {
            this.start()
        } else {
            Upload.queue.push(this);
        }
    }
    start() {
        Upload.active += 1;
        this.$progress.removeClass('rotating');
        this.progressbar.set(0);
        let url = new URL(window.location);
        let search = new URLSearchParams();
        search.set('action', 'upload');
        url.search = search;
        let fd = new FormData();
        fd.append('dest', this.parent.path);
        fd.append('file', this.file);
        $.post({
            url: url,
            data: fd,
            xhr: (() => {
                let xhr = $.ajaxSettings.xhr();
                xhr.upload.onprogress = (e) => {
                    let percent = e.loaded / e.total;
                    this.progressbar.animate(percent);
                };
                return xhr;
            }).bind(this),
            cache: false,
            contentType: false,
            processData: false,
            success: ((json) => {
                Upload.active -= 1;
                this.$progress.remove();
                let upload;
                if (upload = Upload.queue.shift()) {
                    upload.start();
                }
            }).bind(this),
            error: ((e) => {
                Upload.active -= 1;
                let upload;
                if (upload = Upload.queue.shift()) {
                    upload.start();
                }                
                setTimeout((() => {
                    this.progressbar.animate(100, {
                        spin: false,
                        color: '#f00',
                    });
                    this.treeview.remove(this.node);
                }).bind(this), 500);
            }).bind(this),
        });
    }
}

treeview.drop_handler = (data) => {
    if (data.type == 'file') {
        for (let file of data.source_files) {
            let upload = new Upload(treeview, data.dest_node, file);
        }
    } else if (data.type == 'local') {
        let url = new URL(window.location);
        let search = new URLSearchParams();
        search.set('action', data.shift ? 'copy' : 'move');
        url.search = search;
        let fd = new FormData();
        fd.append('dest', data.dest_node.path);
        console.log(data.selected_parents);
        for (let node of data.selected_parents) {
            fd.append('paths', node.path);
        }
        $.post({
            url: url,
            data: fd,
            processData: false,
            contentType: false,
            success: (json) => {
                if (!data.shift) {
                    data.source_node.$li.trigger('dragend');
                }
                for (let node of data.selected_parents) {
                    [_, paths] = data.source_tree.list(node);
                    data.dest_tree.insert(paths, data.dest_node.path);
                    if (!data.shift) {
                        data.source_tree.remove(node);
                    }
                }
            },
        });
    }
};

let url = new URL(window.location);
let search = new URLSearchParams();
search.set('action', 'list');
url.search = search;
$.get(url, (data) => {
    $.each(data.paths, (_, path) => treeview.insert(path));
});

</script>
{% endblock %}